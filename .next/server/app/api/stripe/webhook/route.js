"use strict";(()=>{var e={};e.id=757,e.ids=[757],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1282:e=>{e.exports=require("child_process")},4770:e=>{e.exports=require("crypto")},7702:e=>{e.exports=require("events")},2615:e=>{e.exports=require("http")},8791:e=>{e.exports=require("https")},1764:e=>{e.exports=require("util")},3398:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>b,patchFetch:()=>v,requestAsyncStorage:()=>l,routeModule:()=>_,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var i={};r.r(i),r.d(i,{POST:()=>m,dynamic:()=>c,runtime:()=>u});var s=r(9303),a=r(8716),o=r(670),n=r(7070),p=r(6029),d=r(9658);let u="nodejs",c="force-dynamic";async function m(e){let t;let r=e.headers.get("stripe-signature")||"",i=await e.text();try{t=p.A.webhooks.constructEvent(i,r,process.env.STRIPE_WEBHOOK_SECRET||"")}catch(e){return n.NextResponse.json({ok:!1,error:e.message},{status:400})}let s=(0,d.h)();if("checkout.session.completed"===t.type){let e=t.data.object,r=e.customer,i=await p.A.customers.retrieve(r),a=i.metadata?.firm_id;if(!a)return n.NextResponse.json({ok:!0});if("subscription"===e.mode){let t=await p.A.subscriptions.retrieve(e.subscription,{expand:["items.data.price"]}),i=t.items.data[0]?.price?.id,o=i===process.env.STRIPE_PRICE_ID_MONTHLY?"monthly":i===process.env.STRIPE_PRICE_ID_YEARLY?"yearly":"monthly";await s.from("firm_billing").update({stripe_customer_id:r,stripe_subscription_id:t.id,plan_type:o,status:"active",updated_at:new Date().toISOString()}).eq("firm_id",a),await s.from("status_cert_events").insert({firm_id:a,event_type:"billing_checkout_completed",payload:{mode:"subscription",planType:o}})}if("payment"===e.mode){if((await s.rpc("increment_credits",{firm_id:a,amount:1})).error){let{data:e}=await s.from("firm_billing").select("credits_balance").eq("firm_id",a).single(),t=(e?.credits_balance||0)+1;await s.from("firm_billing").update({credits_balance:t,updated_at:new Date().toISOString()}).eq("firm_id",a)}await s.from("status_cert_events").insert({firm_id:a,event_type:"billing_checkout_completed",payload:{mode:"payment",creditsAdded:1}})}}if("customer.subscription.deleted"===t.type||"customer.subscription.updated"===t.type){let e=t.data.object,r=e.customer,i=await p.A.customers.retrieve(r),a=i.metadata?.firm_id;a&&await s.from("firm_billing").update({stripe_customer_id:r,stripe_subscription_id:e.id,status:e.status,updated_at:new Date().toISOString()}).eq("firm_id",a)}return n.NextResponse.json({ok:!0})}let _=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/yadvinder.singh/Documents/New project/src/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:f,serverHooks:h}=_,b="/api/stripe/webhook/route";function v(){return(0,o.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},6029:(e,t,r)=>{r.d(t,{A:()=>i});let i=new(r(8472)).Z(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2024-04-10",typescript:!0})},9658:(e,t,r)=>{r.d(t,{h:()=>s});var i=r(7857);function s(){return(0,i.eI)("https://txyjzawvhknrtzwkennn.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[276,786,972,472],()=>r(3398));module.exports=i})();